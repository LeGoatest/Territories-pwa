<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Territories Strategy - Spec v1.1</title>
    <link rel="stylesheet" href="assets/css/output.css">
    <link rel="manifest" href="manifest.webmanifest">
    <script src="assets/js/iconify.min.js"></script>
    <script src="assets/js/engine.js"></script>
</head>
<body class="bg-[#FAFAFA] font-sans antialiased overflow-hidden">
    <div class="h-screen flex flex-col">

        <header class="app-bar h-16 flex items-center px-6 justify-between shrink-0 z-20">
            <div class="flex items-center gap-3">
                <span class="icon-[mdi--map-legend] text-2xl"></span>
                <h1 class="text-xl font-medium tracking-tight uppercase">TERRITORIES</h1>
            </div>
            <div class="flex gap-4 items-center">
                <button id="install-btn" class="hidden text-[10px] font-bold border border-white/30 px-3 py-1.5 rounded uppercase hover:bg-white/10 transition-colors">Install App</button>
                <a href="SAGT_INDEX.md" class="text-xs font-bold border border-white/30 px-3 py-1.5 rounded uppercase hover:bg-white/10 transition-colors">GOVERNANCE</a>
            </div>
        </header>

        <div id="game-container" class="flex-1 flex flex-col relative overflow-hidden">
            <!-- HUD will be injected here -->
            <div id="hud-container"></div>

            <div id="board-viewport" class="flex-1 overflow-auto p-4 md:p-8 flex items-start justify-center bg-gray-50">
                <div id="board-anchor" class="relative inline-block paper">
                    <!-- Board Table will be injected here -->
                </div>
            </div>

            <!-- Start Screen Overlay -->
            <div id="start-screen" class="absolute inset-0 z-30 bg-white/95 flex flex-col items-center justify-center p-6 transition-opacity duration-300">
                <div class="max-w-md w-full text-center space-y-8">
                    <div class="space-y-2">
                        <span class="icon-[mdi--map-legend] text-6xl text-[#375E97]"></span>
                        <h2 class="text-4xl font-black text-gray-900 tracking-tighter">TERRITORIES</h2>
                        <p class="text-gray-500 font-medium">Strategic Land Grab Game</p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100 space-y-4">
                        <div class="text-left">
                            <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest block mb-2">Select Difficulty</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setDifficulty(1)" id="diff-1" class="diff-btn active px-4 py-3 rounded-xl border-2 font-bold text-sm transition-all">LEVEL 1</button>
                                <button onclick="setDifficulty(2)" id="diff-2" class="diff-btn px-4 py-3 rounded-xl border-2 font-bold text-sm transition-all">LEVEL 2</button>
                                <button onclick="setDifficulty(0)" id="diff-0" class="diff-btn px-4 py-3 rounded-xl border-2 font-bold text-sm transition-all">PVP</button>
                            </div>
                        </div>

                        <button onclick="startGame()" class="w-full bg-[#375E97] text-white py-4 rounded-xl font-black text-lg shadow-lg shadow-blue-900/20 hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-tight">
                            Start New Game
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GAME STATE ---
        let game = null;
        let selectedDifficulty = 1;
        let touchAnchor = null;

        const COLORS = {
            P1: '#375E97',
            P2: '#FB6542',
            EMPTY: 'transparent'
        };

        // --- CORE FUNCTIONS ---

        function setDifficulty(lvl) {
            selectedDifficulty = lvl;
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active', 'border-[#375E97]', 'text-[#375E97]', 'bg-blue-50'));
            const activeBtn = document.getElementById(`diff-${lvl}`);
            activeBtn.classList.add('active', 'border-[#375E97]', 'text-[#375E97]', 'bg-blue-50');
        }

        function startGame(seed = null) {
            game = new Engine(40, 15, seed);
            game.aiLevel = selectedDifficulty;
            game.vsAI = selectedDifficulty > 0;

            document.getElementById('start-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'none';
            }, 300);

            renderAll();
        }

        function restartWithSeed() {
            if (!game) return;
            startGame(game.seed);
        }

        function copySeed() {
            if (!game) return;
            navigator.clipboard.writeText(game.seed);
            alert('Seed copied to clipboard: ' + game.seed);
        }

        // --- ENGINE ACTIONS ---

        function handleRoll() {
            if (game.gameOver || game.dice) return;
            game.rollDice();
            renderAll();
        }

        function handleRotate() {
            if (!game.dice) return;
            game.rotateDice();
            renderAll();
        }

        function handlePass() {
            game.applyPass();
            checkAITurn();
            renderAll();
        }

        function handlePlace(x, y) {
            const active = game.activeDice;
            if (!active) return;

            const success = game.applyPlacement(game.currentPlayer, { x, y, w: active.w, h: active.h });
            if (success) {
                touchAnchor = null;
                checkAITurn();
                renderAll();
            }
        }

        async function checkAITurn() {
            while (!game.gameOver && game.currentPlayer === PLAYER_2 && game.vsAI) {
                renderAll(); // Show "Thinking" state
                await new Promise(r => setTimeout(r, 600)); // Dramatic pause
                const ai = new AI(game, game.aiLevel);
                const move = ai.getMove();
                if (move.type === 'pass') game.applyPass();
                else game.applyPlacement(PLAYER_2, move.rect);
            }
            renderAll();
        }

        // --- RENDERING ---

        function renderAll() {
            renderHUD();
            renderBoard();
        }

        function renderHUD() {
            const score = game.getScore();
            const p1Percent = ((score.p1 / score.total) * 100).toFixed(1);
            const p2Percent = ((score.p2 / score.total) * 100).toFixed(1);
            const active = game.activeDice;
            const isP1 = game.currentPlayer === PLAYER_1;
            const thinking = !game.gameOver && !isP1 && game.vsAI;

            const html = `
                <div class="bg-white border-b border-gray-200 shadow-sm px-4 md:px-8 py-4 grid grid-cols-3 items-center shrink-0 z-10">
                    <div class="flex flex-col items-start gap-1">
                        <div class="flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-[#375E97] flex items-center justify-center text-white font-bold">A</div>
                            <span class="font-bold text-[#375E97] hidden md:inline">ALICE</span>
                            ${isP1 ? '<span class="text-[#375E97] animate-pulse">◀</span>' : ''}
                        </div>
                        <div class="w-full max-w-[120px] bg-gray-100 h-2 rounded-full overflow-hidden mt-1">
                            <div class="bg-[#375E97] h-full transition-all duration-500" style="width: ${p1Percent}%"></div>
                        </div>
                        <span class="text-[9px] md:text-[10px] font-bold text-gray-500 uppercase">${p1Percent}% OCCUPIED</span>
                    </div>

                    <div class="flex flex-col items-center justify-center min-h-[140px]">
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">
                            ${game.gameOver ? 'GAME OVER' : (thinking ? 'BOB IS THINKING...' : (isP1 ? 'YOUR TURN' : 'PLAYER 2 TURN'))}
                        </div>
                        <div class="text-[9px] text-gray-300 font-mono mb-3 uppercase tracking-tighter">${game.lastAction}</div>

                        ${active && !game.gameOver && isP1 ? `
                        <div class="flex flex-col items-center gap-3">
                            <div class="flex items-center gap-2 md:gap-4">
                                <button onclick="handleRotate()" class="bg-gray-100 hover:bg-gray-200 p-2 rounded-lg transition-colors flex items-center gap-2 text-[10px] font-bold text-gray-600">
                                     <span class="icon-[mdi--rotate-right] text-lg"></span> <span class="hidden md:inline">ROTATE</span>
                                </button>
                                <div class="bg-gray-50 border border-gray-200 p-2 px-4 rounded shadow-inner font-black text-2xl text-gray-700 tracking-tight">
                                    ${active.w} × ${active.h}
                                </div>
                                <button onclick="handlePass()" class="bg-gray-100 hover:bg-red-50 text-gray-400 hover:text-red-600 p-2 rounded-lg transition-colors text-[10px] font-bold uppercase">
                                    PASS
                                </button>
                            </div>
                            <div class="text-[9px] font-bold text-[#375E97] animate-pulse uppercase hidden md:block">Click on board to place</div>
                        </div>
                        ` : `
                        ${!game.gameOver && isP1 && !active ? `
                        <button onclick="handleRoll()" class="bg-[#375E97] text-white px-6 md:px-10 py-3 rounded-lg shadow-md hover:opacity-90 active:scale-95 transition-all font-bold text-sm uppercase">
                            ROLL DICE
                        </button>
                        ` : ''}
                        `}

                        ${game.gameOver ? `
                            <div class="text-xl font-black text-[#375E97] mt-1 uppercase tracking-tight text-center">
                                ${game.winner === 'DRAW' ? 'DRAW!' : (game.winner === PLAYER_1 ? 'ALICE WINS!' : 'BOB WINS!')}
                            </div>
                            <button onclick="document.getElementById('start-screen').style.display='flex'; document.getElementById('start-screen').style.opacity='1';" class="mt-2 text-xs font-bold text-gray-500 underline uppercase hover:text-[#375E97] transition-colors">Change Setup</button>
                        ` : ''}

                        <div class="flex items-center gap-3 mt-4">
                            <button onclick="copySeed()" class="text-[9px] font-mono text-gray-400 hover:text-gray-600 transition-colors uppercase cursor-pointer">Seed: ${game.seed}</button>
                            <button onclick="restartWithSeed()" title="Restart Same Seed" class="text-gray-300 hover:text-[#375E97] transition-colors"><span class="icon-[mdi--refresh] text-sm"></span></button>
                            <button onclick="startGame()" title="New Random Game" class="text-gray-300 hover:text-[#375E97] transition-colors"><span class="icon-[mdi--shuffle] text-sm"></span></button>
                        </div>
                    </div>

                    <div class="flex flex-col items-end gap-1">
                        <div class="flex items-center gap-2">
                            ${!isP1 && !game.gameOver ? '<span class="text-[#FB6542] animate-pulse">▶</span>' : ''}
                            <span class="font-bold text-[#FB6542] hidden md:inline">${game.vsAI ? 'BOB (BOT)' : 'PLAYER 2'}</span>
                            <div class="w-8 h-8 rounded-full bg-[#FB6542] flex items-center justify-center text-white font-bold">B</div>
                        </div>
                        <div class="w-full max-w-[120px] bg-gray-100 h-2 rounded-full overflow-hidden mt-1">
                            <div class="bg-[#FB6542] h-full transition-all duration-500" style="width: ${p2Percent}%"></div>
                        </div>
                        <span class="text-[9px] md:text-[10px] font-bold text-gray-500 uppercase">${p2Percent}% OCCUPIED</span>
                    </div>
                </div>
            `;
            document.getElementById('hud-container').innerHTML = html;
        }

        function renderBoard() {
            const anchor = document.getElementById('board-anchor');
            const active = game.activeDice;

            // Set required data attributes
            anchor.setAttribute('data-current-player', game.currentPlayer);
            anchor.setAttribute('data-game-over', game.gameOver);
            anchor.setAttribute('data-dice-w', active ? active.w : 0);
            anchor.setAttribute('data-dice-h', active ? active.h : 0);

            // Pre-calculate reachable cells for high-fidelity highlights
            const reachable = new Set();
            if (!game.gameOver && game.currentPlayer === PLAYER_1 && active) {
                const anchors = game.getValidPlacements(PLAYER_1, active.w, active.h);
                for (const rect of anchors) {
                    for (let i = 0; i < rect.h; i++) {
                        for (let j = 0; j < rect.w; j++) {
                            reachable.add(`${rect.x + j},${rect.y + i}`);
                        }
                    }
                }
            }

            let html = '<table class="board-table mx-auto relative">';
            for (let y = 0; y < game.height; y++) {
                html += '<tr>';
                for (let x = 0; x < game.width; x++) {
                    const owner = game.board[y][x];
                    let cellStyle = '';
                    if (owner === PLAYER_1) cellStyle = `background-color: ${COLORS.P1};`;
                    else if (owner === PLAYER_2) cellStyle = `background-color: ${COLORS.P2};`;

                    const isReachable = reachable.has(`${x},${y}`);
                    const isValidAnchor = !game.gameOver && game.currentPlayer === PLAYER_1 && active && game.isValidPlacement(PLAYER_1, x, y, active.w, active.h);
                    const isTouchAnchor = touchAnchor && touchAnchor.x === x && touchAnchor.y === y;

                    let cellClass = 'cell';
                    if (isReachable) cellClass += ' cell-valid';
                    if (isValidAnchor) cellClass += ' cell-anchor';
                    if (isTouchAnchor) cellClass += ' cell-touch-anchor';

                    html += `<td id="cell-${x}-${y}" class="${cellClass}" style="${cellStyle}" data-x="${x}" data-y="${y}"></td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            anchor.innerHTML = html;

            // Re-attach event listeners to the new DOM
            attachBoardListeners();
        }

        // --- INPUT HANDLING ---

        function attachBoardListeners() {
            const board = document.querySelector('.board-table');
            const anchor = document.getElementById('board-anchor');

            board.addEventListener('mousemove', (e) => {
                const cell = e.target.closest('.cell');
                if (!cell) { hideGhost(); return; }
                updateGhost(cell);
            });

            board.addEventListener('mouseleave', hideGhost);

            board.addEventListener('click', (e) => {
                const cell = e.target.closest('.cell');
                if (!cell) return;
                handlePlace(parseInt(cell.dataset.x), parseInt(cell.dataset.y));
            });

            // Touch Support
            board.addEventListener('touchstart', (e) => {
                const touch = e.touches[0];
                const cell = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.cell');
                if (!cell) return;

                const x = parseInt(cell.dataset.x);
                const y = parseInt(cell.dataset.y);

                if (touchAnchor && touchAnchor.x === x && touchAnchor.y === y) {
                    handlePlace(x, y);
                } else {
                    touchAnchor = { x, y };
                    updateGhost(cell);
                }
            });
        }

        function updateGhost(cell) {
            const active = game.activeDice;
            if (!active || game.gameOver || game.currentPlayer !== PLAYER_1) { hideGhost(); return; }

            let ghost = document.getElementById('ghost-piece');
            if (!ghost) {
                ghost = document.createElement('div');
                ghost.id = 'ghost-piece';
                ghost.className = 'ghost-piece';
                document.getElementById('board-anchor').appendChild(ghost);
            }

            const x = parseInt(cell.dataset.x);
            const y = parseInt(cell.dataset.y);
            const isValid = game.isValidPlacement(PLAYER_1, x, y, active.w, active.h);

            const cellSize = cell.offsetWidth;
            ghost.style.width = (cellSize * active.w) + 'px';
            ghost.style.height = (cellSize * active.h) + 'px';
            ghost.style.top = cell.offsetTop + 'px';
            ghost.style.left = cell.offsetLeft + 'px';
            ghost.style.display = 'block';

            ghost.classList.toggle('invalid', !isValid);
            ghost.classList.toggle('valid', isValid);
        }

        function hideGhost() {
            const ghost = document.getElementById('ghost-piece');
            if (ghost) ghost.style.display = 'none';
        }

        // --- SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js', { updateViaCache: 'none' }).then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            if (confirm('New version available! Reload now?')) window.location.reload();
                        }
                    };
                };
            });
        }

        // PWA Install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('install-btn').classList.remove('hidden');
        });

        document.getElementById('install-btn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt = null;
            document.getElementById('install-btn').classList.add('hidden');
        });

        // Initialize with Level 1 selected
        setDifficulty(1);
    </script>
</body>
</html>
